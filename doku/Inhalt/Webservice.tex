\chapter{Webservice}
Für den Zugriff auf die Daten stellen wir den Webservice \texttt{StudMap.Service} zur Verfügung.
Der Webservice besteht dabei aus zwei Schnittstellen in Form von sogenannten Controller Klassen, die jeweils von der Klasse \texttt{ApiController} \footnote{siehe: \href{http://msdn.microsoft.com/en-us/library/system.web.http.apicontroller(v=vs.108).aspx}{MSDN Dokumentation}}  abgeleitet sind:
\begin{itemize}
\item \texttt{MapsController}: Verwaltung von Karten- und Routeninformationen
\item \texttt{UsersController}: Verwaltung von Benutzerinformationen
\end{itemize}

Bevor nun die Funktionen der jeweiligen Controller Klasse erläutert werden, folgt eine Übersicht, über die verschiedenen Rückgabe Werte und ihre Bedeutung.

\section{Allgemeine Objekte}
Im folgenden werden die im Webservice verwendeten Objekte aufgeführt. Für jedes Objekt werden Eigenschaften und die Repräsentation der Daten im JSON-Format aufgelistet.

\subsection{Edge}
\label{object:Edge}
Repräsentiert eine Kante in einem Graphen.

Eigenschaften:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline StartNodeId & ID des Start-Knotens der Kante. \\ 
\hline EndNodeId & ID des End-Knotens der Kante. \\ 
\hline
\end{tabularx} 

Beispiel:
\begin{lstlisting}
{
  "StartNodeId": 12,
  "EndNodeId": 6
}
\end{lstlisting}


\subsection{Node}
\label{object:Node}
Repräsentiert einen Knoten in einem Graphen.

Eigenschaften:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline Id & ID des Knotens. \\ 
\hline X & X-Koordinate auf dem Bild des Stockwerks. Wertebereich: 0.0 - 1.0. 0.0 bedeutet linker Bildrand. 1.0 bedeutet rechter Bildrand. \\ 
\hline Y & Y-Koordinate auf dem Bild des Stockwerks. Wertebereich: 0.0 - 1.0. 0.0 bedeutet oberer Bildrand. 1.0 bedeutet unterer Bildrand. \\ 
\hline FloorId & ID des Stockwerks auf dem sich der Knoten befindet. \\ 
\hline 
\end{tabularx} 

Beispiel:
\begin{lstlisting}
{
  "Id": 12,
  "X": 0.45,
  "Y": 0.76,
  "FloorId": 2
}
\end{lstlisting}


\subsection{Graph}
\label{object:Graph}
Repräsentiert für ein Stockwerk den entsprechenden Graphen.

Eigenschaften:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline FloorId & ID des Stockwerks, das der entsprechende Graph repräsentiert. \\ 
\hline Edges & Eine Liste von Kanten (s. \nameref{object:Edge}). \\ 
\hline Nodes & Eine Liste von Knoten (s. \nameref{object:Node}). \\ 
\hline 
\end{tabularx} 

Beispiel:
\begin{lstlisting}
{
  "FloorId": 12,
  "Edges": { {...}, {...}, {...} },
  "Nodes": { {...}, {...}, {...} }
}
\end{lstlisting}


\subsection{Pathplot}
\label{object:Pathplot}
\todo{Bitte noch entsprechend vervollständigen!}
Repräsentiert für die Darstellung benötigte Daten.

Eigenschaften:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline Id & ?? \\ 
\hline Classes & ?? \\
\hline Points & Eine Liste von \nameref{object:Node} Objekten. \\
\end{tabularx} 

Beispiel:
\begin{lstlisting}
{
  "Id": "flt-1",
  "Classes": "planned",
  "Points": { {...}, {...}, {...} }
}
\end{lstlisting}

\subsection{FloorPlanData}
\label{object:FloorPlanData}
\todo{Bitte noch entsprechend vervollständigen!}
Repräsentiert Daten die auf einem Bild dargestellt werden können.

Eigenschaften:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline Pathplot &  \\ 
\hline Graph & \\ 
\hline
\end{tabularx} 

Beispiel:
\begin{lstlisting}
{
  "Pathplot": {...},
  "Graph": {...}
}
\end{lstlisting}


\subsection{Room}
\label{object:Room}
Repräsentiert Daten die für einen Raum relevant sind.

Eigenschaften:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline NodeId & ID des Knotens an dem sich der Raum befindet. \\ 
\hline DisplayName & Der Anzeigename für den Raum (z.B. Aquarium) \\ 
\hline RoomName & Der eigentliche Raumname (z.B. A 2.0.11). \\ 
\hline 
\end{tabularx} 

Beispiel:
\begin{lstlisting}
{
  "NodeId": 12,
  "DisplayName": "Aquarium",
  "RoomName": "A2.0.11"
}
\end{lstlisting}


\subsection{PoiType}
\label{object:PoiType}
Repräsentiert einen \nameref{object:PoI} Typen, wie beispielsweise Mensa oder Bibliothek.

Eigenschaften:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline Id & ID des Poi Typs. \\ 
\hline Name & Der Name des Poi Tpes (z.B. Mensa). \\ 
\hline 
\end{tabularx} 

Beispiel:
\begin{lstlisting}
{
  "Id": 12,
  "Name": "Mensa"
}
\end{lstlisting}


\subsection{PoI}
\label{object:PoI}
Repräsentiert einen Point Of Interest, wie beispielsweise eine Mensa oder eine Bibliothek.

Eigenschaften:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline Type & Typ des PoIs (s. \nameref{object:PoiType}). \\ 
\hline Description & Beschreibung des PoIs. \\ 
\hline 
\end{tabularx} 

Beispiel:
\begin{lstlisting}
{
  "Type": 1,
  "Description": "In der Mensa kann man essen."
}
\end{lstlisting}


\subsection{NodeInformation}
\label{object:NodeInformation}
Repräsentiert die für einen Knoten relevanten Daten.

Eigenschaften:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline DisplayName & Anzeigename für den Knoten (z.B. Dr. Schulten, Martin). \\ 
\hline RoomName & Raumname für den Knoten (z.B. B2.0.03). \\ 
\hline Node & ?? \\ 
\hline PoI & ?? \\  
\hline QRCode & Dem Knoten zugeordnetem QR Code. \\ 
\hline NFCTag & Dem Knoten zugeordnetem NFC Tag. \\ 
\hline 
\end{tabularx} 

Beispiel:
\begin{lstlisting}
{
  "DisplayName": "Dr. Schulten, Martin",
  "RoomName": "B2.0.03",
  "Node": {...},
  "PoI": {...},
  "QRCode": "",
  "NFCTag": ""
}
\end{lstlisting}


\subsection{Floor}
\label{object:Floor}
Repräsentiert die für ein Stockwerk relevanten Daten.

Eigenschaften:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline Id & ID des Stockwerks. \\ 
\hline MapId & ID der Karte zu dem das Stockwerk gehört. \\ 
\hline Name & Name des Stockwerks. \\ 
\hline ImageUrl & Der Dateipfad auf dem Server zum Bild des Stockwerks. \\  
\hline CreationTime & Zeitstempel, an dem das Stockwerk erstellt wurde. \\ 
\hline 
\end{tabularx} 

Beispiel:
\begin{lstlisting}
{
  "Id": 1011,
  "MapId": 3,
  "Name": "Ebene 0",
  "ImageUrl": "Images/Floors/RN_Ebene_0.png",
  "CreationTime": "2013-11-18 14:36:24.607"
}
\end{lstlisting}


\subsection{Map}
\label{object:Map}
Repräsentiert die für eine Karte relevanten Daten.

Eigenschaften:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline Id & ID der Karte. \\ 
\hline Name & Name der Karte. \\ 
\hline 
\end{tabularx} 

Beispiel:
\begin{lstlisting}
{
  "Id": 3,
  "Name": "Westfälische Hochschule",
}
\end{lstlisting}


\subsection{User}
\label{object:User}
Repräsentiert die für einen Benutzer relevanten Daten.

Eigenschaften:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline Name & Name des Benutzers. \\ 
\hline 
\end{tabularx} 

Beispiel:
\begin{lstlisting}
{
  "Name": "Daniel",
}
\end{lstlisting}

\subsection{FloorGraph}
\label{object:FloorGraph}
Repräsentiert einen Teilgraph für ein Stockwerk.

Eigenschaften:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline floorId & ID des Stockwerks. \\ 
\hline graph & Der Teilgraph (s. \nameref{object:Graph}) für das Stockwerk. \\ 
\hline
\end{tabularx}

Beispiel: 
\begin{lstlisting}
{
  "floorId": 2,
  "graph": {...}
}
\end{lstlisting}


\subsection{NodeInformationWithId}
\label{object:NodeInformationWithId}
\begin{tabularx}{\textwidth}{|l|X|}
\hline nodeId & ID des \nameref{object:Node}. \\ 
\hline nodeInf & Die Knoteninformation die gespeichert werden soll (s. \nameref{object:NodeInformation}). \\ 
\hline
\end{tabularx}

Beispiel: 
\begin{lstlisting}
{
  "nodeId": 12,
  "nodeInf": {...}
}
\end{lstlisting}



\section{Rückgabe Objekte}

\subsection{BaseResponse}
\label{BaseResponse}
Allgemeine Rückgabe vom Service, die einen Status und ggf. einen Fehler enthält. Die Daten werden im JSON Format zurück gegeben.

\textbf{Beispiel:}
\begin{verbatim}
{ "Status":1, "ErrorCode":0 }
\end{verbatim}

\subsubsection{ResponseStatus}
Wir unterscheiden zwischen:
\begin{itemize}
\item \texttt{None = 0}: Defaultwert
\item \texttt{Ok = 1}: Funktion erfolgreich ausgeführt
\item \texttt{Error = 2} Fehler bei Funktionsausführung
\end{itemize}

\subsubsection{ResponseError}
Ist beim \texttt{ResponseStatus Error} gesetzt. Es werden folgende Fehlerszenarien unterschieden:

\textbf{Allgemein:}
\begin{itemize}
\item \texttt{001 - DatabaseError}:\\
Fehler bei der Ausführung einer Datenbankabfrage.
\end{itemize}

\textbf{Registrierung:}
\begin{itemize}
\item \texttt{101 - UserNameDuplicate}:\\
Der Benutzername ist bereits vergeben.
\item \texttt{102 - UserNameInvalid}:\\
Der Benutzername ist ungültig.
\item \texttt{103 - PasswordInvalid}:\\
Das Passwort ist ungültig.
\end{itemize}

\textbf{Anmeldung:}
\begin{itemize}
\item \texttt{110 - LoginInvalid}:\\
Die Logindaten (Name oder Passwort) sind ungültig.
\end{itemize}

\textbf{Maps:}
\begin{itemize}
\item \texttt{201 - MapIdDoesNotExist}:\\
Zur angeforderten MapId existiert keine Map.
\item \texttt{202 - FloorIdDoesNotExist}:\\
Zur angeforderten FloorId existiert kein Floor.
\end{itemize}

\subsection{ObjectResponse}
\label{ObjectResponse}
Eine generische Klasse die \nameref{BaseResponse} um ein Feld \texttt{Object} erweitert, indem die Nutzdaten gespeichert werden.

Beispiel:
\todo{ObjectResponse als JSON String einfügen}

\subsection{ListResponse}
\label{ListResponse}
Eine generische Klasse die \nameref{BaseResponse} um eine Liste \texttt{List} erweitert, indem Nutzdaten in Form einer Collection gespeichert werden.

Beispiel:
\begin{verbatim}
{"List":[],"Status":1,"ErrorCode":0}
\end{verbatim}

\section{MapsController}

\subsection{CreateMap}
\label{service:CreateMap}
Erstellt eine neue Karte mit dem vorgegebenen Namen.

POST
\url{/api/Maps/CreateMap?mapName=WHS}

Parameter:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline mapName & Sprechender Name der Karte. \\ 
\hline 
\end{tabularx} 

Rückgabewert: \nameref{ObjectResponse}, \nameref{object:Map}

\subsection{DeleteMap}
\label{service:DeleteMap}
Löscht eine Karte mit der angegebenen ID.

POST
\url{/api/Maps/DeleteMap?mapId=2}

Parameter:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline mapId & ID der Map, die gelöscht werden soll. \\ 
\hline 
\end{tabularx} 

Rückgabewert: \nameref{BaseResponse}

\subsection{GetMaps}
\label{service:GetMaps}
Liefert eine Liste aller Karten zurück.

GET
\url{/api/Maps/GetMaps}

Rückgabewert: \nameref{ListResponse}, \nameref{object:Map}

\subsection{SaveGraphForFloor}
\label{service:SaveGraphForFloor}
Speichert den Graphen zu einem Stockwerk ab.

POST
\url{/api/Maps/SaveGraphForFloor}

POST Body: \nameref{object:FloorGraph}

Rückgabewert: \nameref{ObjectResponse}, \nameref{object:Graph}

\subsection{DeleteGraphForFloor}
\label{service:DeleteGraphForFloor}
Löscht den Teilgraphen auf einem Stockwerk.
Die Teilgraphen auf anderen Stockwerken werden nicht verändert.
Kanten die Stockwerke mit diesem Stockwerk verbinden, werden
ebenfalls entfernt.

POST
\url{/api/Maps/DeleteGraphForFloor?floorId=2}

Parameter:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline floorId & ID des Stockwerks, dessen Teilgraph gelöscht werden soll. \\ 
\hline 
\end{tabularx} 

Rückgabewert: \nameref{BaseResponse}

\subsection{GetGraphForFloor}
\label{service:GetGraphForFloor}
Liefert den Teilgraphen für ein Stockwerk.

GET
\url{/api/Maps/GetGraphForFloor?floorId=2}

Parameter:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline floorId & ID des Stockwerks. \\ 
\hline 
\end{tabularx} 

Rückgabewert: \nameref{ObjectResponse}, \nameref{object:Graph}

\subsection{GetNodeInformationForNode}
\label{service:GetNodeInformationForNode}
Liefert weitere Informationen zu einem Knoten.
Diese umfassen Raumnummern, zugeordnete NFC- und QR-Tags, usw.

GET
\url{/api/Maps/GetNodeInformationForNode?nodeId=12}

Parameter:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline nodeId & ID des Knotens. \\ 
\hline 
\end{tabularx} 

Rückgabewert: \nameref{ObjectResponse}, \nameref{object:Graph}

\subsection{GetFloorPlanData}
\label{service:GetFloorPlanData}
Liefert die verschiedenen Schichten auf einem Stockwerk.

GET
\url{/api/Maps/GetFloorPlanData?floorId=2}

Parameter:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline floorId & ID des Stockwerks. \\ 
\hline 
\end{tabularx} 

Rückgabewert: \nameref{ObjectResponse}, \nameref{object:FloorPlanData}

\subsection{SaveNodeInformation}
\label{service:SaveNodeInformation}
Speichert zusätzliche Informationen zu einem Knoten ab.

POST
\url{/api/Maps/SaveNodeInformation}

POST Body: \nameref{object:NodeInformationWithId}

Rückgabewert: \nameref{ObjectResponse}, \nameref{object:NodeInformation}

\subsection{GetRouteBetween}
\label{service:GetRouteBetween}
Liefert die Route zwischen zwei Knoten, wenn diese existiert.

GET
\url{/api/Maps/GetRouteBetween?mapId=2&startNodeId=12&endNodeId=46}

Parameter:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline mapId & ID des Karte, auf der die Route bestimmt werden soll. \\ 
\hline startNodeId & ID des Startknotens. \\ 
\hline endNodeId & ID des Zielknotens. \\ 
\hline 
\end{tabularx} 

Rückgabewert: \nameref{ListResponse}, \nameref{object:Node}

\subsection{GetPoiTypes}
\label{service:GetPoiTypes}
Liefert eine Liste aller Typen von PoIs zurück.

GET
\url{/api/Maps/GetPoiTypes}

Rückgabewert: \nameref{ListResponse}, \nameref{object:PoiType}

\subsection{GetPoIsForMap}
\label{service:GetPoIsForMap}
Liefert eine Liste aller PoIs auf einer Karte zurück.

GET
\url{/api/Maps/GetPoIsForMap?mapId=2}

Parameter:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline mapId & ID der Karte. \\ 
\hline 
\end{tabularx} 

Rückgabewert: \nameref{ListResponse}, \nameref{object:PoI}

\subsection{GetRoomsForMap}
\label{service:GetRoomsForMap}
Liefert eine Liste aller Räume auf einer Karte zurück.

GET
\url{/api/Maps/GetRoomsForMap?mapId=2}

Parameter:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline mapId & ID der Karte. \\ 
\hline 
\end{tabularx} 

Rückgabewert: \nameref{ListResponse}, \nameref{object:Room}

\subsection{GetNodeForNFC}
\label{service:GetNodeForNFC}
Sucht auf einer Karte nach einem Knoten mit einem bestimmten NFC-Tag.

GET
\url{/api/Maps/GetNodeForNFC?mapId=2&nfcTag=46A6CG739ED9}

Parameter:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline mapId & ID der Karte. \\ 
\hline nfcTag & NFC-Tag, nach dem gesucht werden soll. \\ 
\hline 
\end{tabularx} 

Rückgabewert: \nameref{ObjectResponse}, \nameref{object:Node}

\subsection{GetNodeForQRCode}
\label{service:GetNodeForQRCode}
Sucht auf einer Karte nach einem Knoten mit einem bestimmten QR-Code.

GET
\url{/api/Maps/GetNodeForQRCode?mapId=2&qrCode=46A6CG739ED9}

Parameter:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline mapId & ID der Karte. \\ 
\hline qrCode & QR-Code, nach dem gesucht werden soll. \\ 
\hline 
\end{tabularx} 

Rückgabewert: \nameref{ObjectResponse}, \nameref{object:Node}

\section{UsersController}
\label{Webservice_UsersController}
Der \texttt{UsersController} stellt klassische Funktionen zur Benutzerverwaltung zur Verfügung.

\subsection{Register}
\label{service:Register}
Registriert einen neuen Anwender in der Benutzerrolle Benutzer.

POST
\url{/api/Users/Register?userName=test&password=geheim}

Parameter:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline userName & Der Benutzername. \\ 
\hline password & Passwort im Klartext. \\ 
\hline 
\end{tabularx} 

Rückgabewert: \nameref{BaseResponse}

\subsection{Login}
\label{service:Login}
Meldet einen bereits registrierten Anwender am System an.

POST
\url{/api/Users/Login?userName=test&password=geheim}

Parameter:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline userName & Der Benutzername. \\ 
\hline password & Passwort im Klartext. \\ 
\hline 
\end{tabularx}

Rückgabewert: \nameref{BaseResponse}

\subsection{Logout}
\label{service:Logout}
Meldet einen angemeldeten Anwender vom System ab.

GET
\url{http://localhost:1129/api/Users/Logout?userName=test}

Parameter:\\
\begin{tabularx}{\textwidth}{|l|X|}
\hline userName & Der Benutzername. \\ 
\hline 
\end{tabularx}

Rückgabewert: \nameref{BaseResponse}

\subsection{GetActiveUsers}
\label{service:GetActiveUsers}
Ermittelt eine Liste der aktuell am System angemeldeten Anwender.

GET
\url{/api/Users/GetActiveUsers}

Rückgabewert: \nameref{ListResponse}, \nameref{object:User}